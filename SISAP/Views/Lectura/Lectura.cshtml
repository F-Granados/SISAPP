
@{
    ViewBag.Title = "Lectura";
}


<div id="modal_aside_right" class="modal fixed-right fade fuente " tabindex="-1" role="dialog">
    <div class="modal-dialog modal-dialog-aside " role="document">
        <div class="modal-content">
            <div class="modal-body mt-4 ">
                <h5>Lecturas</h5>
                <hr style="border-style: dashed;" />

                <div class="row">
                    <div class="row  col-6">
                        <div hidden class="col-sm-4 mb-3">
                            <label>Año</label>
                            <select id="ddAnnio" class="form-control form-control-sm">
                            </select>
                        </div>
                        <div hidden class="col-sm-4 mb-3 ">
                            <label>Mes</label>
                            <select id="ddMes" class="form-control form-control-sm">
                            </select>
                        </div>
                        <div class="col-sm-4 mb-3 ">
                            <label>Ruta</label>
                            <select id="ddUrbanizacion" class="form-control form-control-sm ">
                            </select>
                        </div>
                    </div>
                    <div class="col-6">

                        <div class="d-flex justify-content-end mt-3">
                            <label id="MSGvalidacion" class=" text-danger mt-4 mr-3" style="display:none">Debe seleccionar los campos de búsqueda</label>
                            <button  type="button" id="btnLecturasAnteriores" class="btn btn-success btn-sm mt-3 calcularOperaciones">Calcular</button>

                            <div hidden class="searchbar">
                                <input class="search_input" type="text" id="txtFilter" name="" placeholder="Buscar...">
                                <a href="#" class="search_icon"><i class="fas fa-search"></i></a>
                            </div>
                        </div>
                    </div>
                </div>
                <table class="table table-sm table-striped table-responsive-sm" id="allGrilla2">
                    <thead>
                        <tr class="bg-info text-light">
                            <th scope="col">ClienteId</th>
                            <th scope="col">Nombre</th>
                            <th scope="col">Direccion</th>
                            <th scope="col">Medidor</th>
                            <th scope="col">Año</th>
                            <th scope="col">Mes</th>
                            <th scope="col">Lec. Anterior</th>
                            <th scope="col">Lec. Actual</th>
                        </tr>
                    </thead>
                </table>


            </div>
            <div class="modal-footer p-1">
                <label id="MSGvalidacion" class=" text-danger" style="display:none">Debe LLenar todos los campos</label>
                <button type="button" class="btn btn-danger btn-sm" data-dismiss="modal">Cerrar</button>
                <button style="display:none;" class="btn btn-success btn-sm" id="btnSave" data-dismiss="modal" type="submit"><i class="fas fa-save"></i> Guardar</button>
                <button style="display:none;" class="btn btn-success btn-sm" id="btnUpdate" data-dismiss="modal" type="submit"><i class="fas fa-save"></i> Actualizar</button>
            </div>
        </div>
    </div>
</div>


<div class="card border-0 ml-4 mt-4 margin-l mb-3 ">
    <div class="card-body fuente">
        <div class=" card-header bg-dark text-white">
            <h5><i class="fas fa-table"> Lecturas</i></h5>
        </div>
        <hr style="border-style: dashed;" />
        <div class="row">
            <div class="row  col-6">
                <div class="col-sm-3 mb-3">
                    <label>Año</label>
                    <select id="ddAnnio2" class="form-control form-control-sm ">

                    </select>
                </div>
                <div class="col-sm-4 mb-3 ">
                    <label>Mes</label>
                    <select id="ddMes2" class="form-control form-control-sm">

                    </select>
                </div>
                <div class="col-sm-4 mb-3 ">
                    <label>Ruta</label>
                    <select id="ddUrbanizacion2" class="form-control form-control-sm ">

                    </select>
                </div>


            </div>

            <div class="col-6">
                <br />

                <div class="d-flex justify-content-end mt-2">
                    <button id="openModal" type="button" data-toggle="modal" data-target="#modal_aside_right" class="btn btn-info btn-sm" onclick="Edit(0)"><i class="fas fa-plus"></i> Registrar</button>
                </div>
            </div>
        </div>
        <table class="table table-sm table-striped table-responsive-sm" id="allGrilla">
            <thead>
                <tr class="bg-info text-light">
                    <th scope="col">Código</th>
                    <th scope="col">Nombre</th>
                    <th scope="col">Direccion</th>
                    <th scope="col">Medidor</th>
                    <th scope="col">Año</th>
                    <th scope="col">Mes</th>
                    <th scope="col">Lec. Anterior</th>
                    <th scope="col">Lec. Actual</th>
                    <th scope="col">Consumo</th>
                    <th scope="col">Promedio</th>
                    <th scope="col">Opciones</th>
                </tr>
            </thead>
        </table>
    </div>
    <div class="modal-footer p-1">
        <button class="btn btn-success btn-sm" id="enviar" type="submit"><i class="fas fa-file-excel"></i> Excel</button>
        <button class="btn btn-dark btn-sm" id="enviar" type="submit"><i class="fas fa-print"></i> Print</button>
    </div>
</div>


<script>
    var tabla;

    var AnnioActual = "@DateTime.Now.ToString("yyyy")";

    $(document).ready(function () {

        $("#openModal").on('click', function () {

            $("#MSGvalidacion").hide();
            $("#btnSave").show();
            $("#btnUpdate").hide();
            //Clean();
            ListarLecturaByFilters();

        })

        $("#ddAnnio").change(function () {
            ListaddMeses();
        });

        $("#ddAnnio2").change(function () {
            ListaddMeses2();
        });

        ListarAnnio();

        ListUrbanizacion();


        $("#ddUrbanizacion").bind("keyup change", function () {
            tabla.draw();
        })


    });

    function ListarLecturaByFilters() {



        tabla = $('#allGrilla2').DataTable({
            "dom": 'Bfrtip',
            "lengthMenu": [[10, 30, 50, -1], [10, 30, 50, "All"]],
            "searching": false,
            "language": {
                "url": "https://cdn.datatables.net/plug-ins/1.10.24/i18n/Spanish.json"
            },
            "drawCallback": function () {
                $('.page-link').addClass('btn-sm  border-0')
            },

            "serverSide": true,
            "processing": true,
            "orderable": false,
            "ajax": {
                "url": '@Url.Content("~/Lectura/ListaLecturaByFilters")',
                "type": 'POST',
                "data": function (d) {
                    return $.extend({}, d, {
                        UrbanizacionId: $("#ddUrbanizacion").val() == "" ? null : $("#ddUrbanizacion").val(),
                    });
                },
                "dataSrc": "data",
                "responsivePriority": 1,
                //"pageLength": 10
            },

            "columns": [
                { "visible": false, "data": "ClienteId"},
                { "data":"NombreCompleto" },
                { "data":"DireccionStr" },
                { "data":"NumeroMedidor" },
                { "data":"Annio" },
                { "data":"Mes" },
                { "data":"CantidadLectura" },


                { 'defaultContent': '<input type="number" id="LecturaActual" class="form-control LecActual">' },
                /*{
                    "data": "id", "render": function (data, type, row, meta) {
                        return "<input type='text' class='form-control consumo' id='txtConsumo' placeholder='' readonly>" 
                    }
                },
                */
                
            ]
        });

        tabla.draw();

        $('#allGrilla2 tbody').on('click', '.LecActual', function () {

            var LecActual = $(this).parents("tr").find('#LecturaActual').val();
            guradarClienteLectura()
        });

    }

    function CalcularConsumo(dLectura) {

    }

    function Edit() {

    }

    function Delete() {}

    function ListarAnnio() {
        var comboAnnio = $("#ddAnnio");
        var comboAnnio2 = $("#ddAnnio2");
        $.ajax({
            type: "POST",
            dataType: "json",
            url: '@Url.Content("~/Common/ListAnnio")',
            async: false,
            success: function (dataObject) {
                var data = dataObject;
                if (data != null) {
                    comboAnnio.html('');
                    comboAnnio2.html('');
                    comboAnnio.append($("<option />").val("").text('--Seleccione--'));
                    comboAnnio2.append($("<option />").val("").text('--Seleccione--'));
                    $.each(data, function () {
                        comboAnnio.append($("<option />").val(this.Value).text(this.Text));
                        comboAnnio2.append($("<option />").val(this.Value).text(this.Text));
                    })
                }
            }
        });
    }

    function ListaddMeses() {
        var comboMes = $("#ddMes");
        $.ajax({
            type: 'POST',
            contentType: "application/json; charset=utf-8",
            url: '@Url.Content("~/Common/ListMes")',
            dataType: "json",
            data: JSON.stringify({ Annio: $("#ddAnnio").val() }),
            async: false,
            success: function (dataObject) {
                var data = dataObject;
                if (data != null) {
                    comboMes.html('');
                    $.each(data, function () {
                        comboMes.append($("<option />").val(this.Value).text(this.Text));
                    });

                }
            },
            error: function (xhr, ajaxOptions, thrownError) {

            }
        });
    }

    function ListaddMeses2() {
        var comboMes2 = $("#ddMes2");
        $.ajax({
            type: 'POST',
            contentType: "application/json; charset=utf-8",
            url: '@Url.Content("~/Common/ListMes")',
            dataType: "json",
            data: JSON.stringify({ Annio: $("#ddAnnio2").val() }),
            async: false,
            success: function (dataObject) {
                var data = dataObject;
                if (data != null) {
                    comboMes2.html('');
                    $.each(data, function () {
                        comboMes2.append($("<option />").val(this.Value).text(this.Text));
                    });

                }
            },
            error: function (xhr, ajaxOptions, thrownError) {

            }
        });
    }


    function ListUrbanizacion() {
        var comboUrbanizacion = $("#ddUrbanizacion");
        var comboUrbanizacion2 = $("#ddUrbanizacion2");
        $.ajax({
            type: "POST",
            dataType: "json",
            url: '@Url.Content("~/Common/ListarUrbanizacion")',
            async: false,
            success: function (dataObject) {
                var data = dataObject;
                if (data != null) {
                    comboUrbanizacion.html('');
                    comboUrbanizacion2.html('');
                    comboUrbanizacion.append($("<option />").val("").text('--Seleccione--'));
                    comboUrbanizacion2.append($("<option />").val("").text('--Seleccione--'));

                    $.each(data, function () {
                        comboUrbanizacion.append($("<option />").val(this.UrbanizacionId).text(this.NombreUrbanizacion));
                        comboUrbanizacion2.append($("<option />").val(this.UrbanizacionId).text(this.NombreUrbanizacion));
                    })
                }
            }
        });
    }
</script>
